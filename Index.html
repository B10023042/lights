<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>慈善亭 | 點燈系統</title>
  <link rel="stylesheet" href="./src/css/headquaters.css">
  <script src="https://www.gstatic.com/firebasejs/4.11.0/firebase.js"></script>
  <script src="https://unpkg.com/vue/dist/vue.js"></script>
  <script src="./dist/vuefire.js"></script>
</head>

<body>

  <div id="app">
    <section id="admin-wrapper">
        <div id="form-wrapper">
            <h1 class="page-title">慈善亭 | 搜尋</h1>
            姓名：<input v-model.trim="search.name" placeholder="姓名">
            <button v-on:click="searchUser">搜尋</button>
        </div>
        <ul>
            <li v-for="data in searchResultData">
                <div id="form-wrapper">
                    燈別
                    <select v-model.trim="data.user.lightType" value = user.lightType>
                        　<option value="光明燈">光明燈</option>
                        　<option value="長明燈">長明燈</option>
                          <option value="安太歲">安太歲</option>
                          <option value="財神燈">財神燈</option>
                          <option value="藥師燈">藥師燈</option>
                          <option value="文昌燈">文昌燈</option>
                          <option value="信徒">信徒</option>
                      </select>
                    姓名<input :value="data.user.name" v-model.trim="data.user.name" >
                    電話<input :value="data.user.phone" v-model.trim="data.user.phone" >
                    <br>
                    生時八字<br>
                    <select v-model.trim="data.user.isChineeseYear" value = data.user.isChineeseYear>
                      　<option value="農曆">農曆</option>
                      　<option value="國曆">國曆</option>
                    </select>
                    民國
                    <input :value="data.user.year" v-model.trim="data.user.year" id="time">年
                    <input :value="data.user.month" v-model.trim="data.user.month"  id="time">月
                    <input :value="data.user.day" v-model.trim="data.user.day"  id="time">日
                    <br>
                    <select value=data.user.isAftermoon v-model.trim="data.user.isAftermoon">
                      　<option value="上午">上午</option>
                      　<option value="下午">下午</option>
                    </select>
                    <input :value="data.user.hour" v-model.trim="data.user.hour" id="time">點
                    <input :value="data.user.minute" v-model.trim="data.user.minute" id="time">時生
                    <br>
                    地址：<input :value="data.user.address" v-model.trim="data.user.address"  id="address">
                    <br>
                    備註：<input :value="data.user.memo" v-model.trim="data.user.memo"  id="memo">
                    <br>
                    <button v-on:click="updateUser(data)">更新</button>
                    <button v-on:click="removeUser(data)">刪除</button>
                  </div>
            </li>
        </ul>
        <h1 class="page-title">慈善亭 | 新增</h1>
        <div id="form-wrapper">
          燈別
          <select v-model.trim="newUser.lightType">
              　<option value="光明燈">光明燈</option>
              　<option value="長明燈">長明燈</option>
                <option value="安太歲">安太歲</option>
                <option value="財神燈">財神燈</option>
                <option value="藥師燈">藥師燈</option>
                <option value="文昌燈">文昌燈</option>
                <option value="信徒">信徒</option>
            </select>
          姓名<input v-model.trim="newUser.name" placeholder="姓名">
          電話<input v-model.trim="newUser.phone" placeholder="電話">
          <br>
          生時八字<br>
          <select v-model.trim="newUser.isChineeseYear">
            　<option value="農曆">農曆</option>
            　<option value="國曆">國曆</option>
          </select>
          民國
          <input v-model.trim="newUser.year" placeholder="年" id="time">年
          <input v-model.trim="newUser.month" placeholder="月" id="time">月
          <input v-model.trim="newUser.day" placeholder="日" id="time">日
          <br>
          <select v-model.trim="newUser.isAftermoon">
            　<option value="上午">上午</option>
            　<option value="下午">下午</option>
          </select>
          <input v-model.trim="newUser.hour" placeholder="點" id="time">點
          <input v-model.trim="newUser.minute" placeholder="時" id="time">時生
          <br>
          地址：<input v-model.trim="newUser.address" placeholder="地址" id="address">
          <br>
          備註：<input v-model.trim="newUser.memo" placeholder="備註" id="address">
          <br>
          <button v-on:click="addUser">新增</button>
        </div>
    </section>



</div>

  <script>
    /* global Vue, firebase */

    var config = {
      apiKey: 'AIzaSyBJykOkltgTEmq5bTCA5pxUUCI52Tghx6g',
      authDomain: 'light-1a6d4.firebaseapp.com',
      databaseURL: 'https://light-1a6d4.firebaseio.com/',
      projectId: 'light-1a6d4',
      storageBucket: 'light-1a6d4.appspot.com',
      messagingSenderId: '66654715141'
    }

    var db = firebase.initializeApp(config).database()
    var userRef = db.ref('User')
    new Vue({
      el: '#app',
      data: {
        newUser: {
                    name: '',
                    phone:'',
                    address: '',
                    year:'',
                    month:'',
                    day:'',
                    hour:'',
                    minute:'',
                    isAftermoon:'上午',
                    isChineeseYear:'農曆',
                    lightType:'光明燈',
                    lightYear:'2018',
                    memo:'',
                    modifyTime:Date.now()
                },
        search: {
            name: ''
        },
        searchResult:{
          key:[],
          user:[]
        },
        searchResultData:[],    
      },
      firebase: {
        Users: userRef.limitToLast(25),
      },
      methods: {
        addUser: function () {
          if (this.newUser) {
            userRef.push({
              name: this.newUser.name,
              phone:this.newUser.phone,
              address:this.newUser.address,
              year: this.newUser.year,
              month: this.newUser.month,
              day: this.newUser.day,
              hour:this.newUser.hour,
              minute:this.newUser.minute,
              isAftermoon: this.newUser.isAftermoon,
              isChineeseYear:this.newUser.isChineeseYear,
              lightType: this.newUser.lightType,
              lightYear:this.newUser.lightYear,
              memo:this.newUser.memo,
              modifyTime:this.newUser.modifyTime
            })
            this.newUser = {
                    name: '',
                    phone:'',
                    address: '',
                    year:'',
                    month:'',
                    day:'',
                    hour:'',
                    minute:'',
                    isAftermoon:'上午',
                    isChineeseYear:'農曆',
                    lightType:'光明燈',
                    lightYear:'2018',
                    memo:'',
                    modifyTime:Date.now()
                }
                location.reload();
          }
        },
        searchUser: function () {
          var self = this;
          userRef.orderByChild('name').equalTo(this.search.name).on("value", function(snapshot) {
            if(snapshot.val()){
            self.searchResult.user = Object.values(snapshot.val())
              let i =0;
              snapshot.forEach(function(data) {
                self.searchResult.key[i]=data.key;
                i++;
              });
              self.formatUser()
            }
            else{
              alert('無此資料')
            }
          });
         
        },
        formatUser: function () {
          let i = 0;
          this.searchResultData=[]
          for (let i =0 ;  i<this.searchResult.key.length;i++ ){
            let userWithKey = { 
              user:this.searchResult.user[i],
              key:this.searchResult.key[i]}
            this.searchResultData.push(userWithKey);
          }
        
        },
        updateUser: function (data) {
         userRef.child(data.key).set(data.user);
         alert('更新完成')
         location.reload();
        },
        removeUser: function (data) {
          userRef.child(data.key).remove();
          alert('刪除完成')
          location.reload();
        }
      }
    })
  </script>
</body>

</html>
